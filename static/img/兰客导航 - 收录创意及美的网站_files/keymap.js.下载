;(function() {
    var version = '1.0.0',
        keys = {},
        $search = document.querySelector('#search'),
        $keyboard = document.querySelector('#keyboard'),
        $keys = document.querySelectorAll('#keyboard li'),
        $setting = document.querySelector('#setting'),
        $close = document.querySelector('.close'),
        $newWindow = document.querySelector('#newWindow'),
        $searchEngine = document.querySelector('#searchEngine')

    // init
    if (localStorage.version != version) {
        localStorage.version = version
        localStorage.newWindow = 1
        localStorage.searchEngine = 'https://www.baidu.com/s?wd='
        localStorage[81] = 'http://www.58pic.com/'
        localStorage[87] = 'https://music.163.com/'
        localStorage[69] = 'https://www.behance.net/'
        localStorage[82] = 'https://dribbble.com/'
        localStorage[84] = 'https://www.tmall.com/'
        localStorage[89] = 'https://www.youtube.com/'
        localStorage[85] = 'https://www.youku.com/'
        localStorage[73] = 'http://www.iconfont.cn/collections/index'
        localStorage[80] = 'https://www.pinterest.com/'
        localStorage[65] = 'http://lackk.com/'
        localStorage[83] = 'https://www.digitaling.com/'
        localStorage[68] = 'https://www.douban.com/'
        localStorage[70] = 'https://translate.google.cn/'
        localStorage[71] = 'http://www.gtn9.com/'
        localStorage[72] = 'http://huaban.com/'
        localStorage[74] = 'https://www.jd.com/'
        localStorage[75] = 'https://www.zcool.com.cn/'
        localStorage[76] = 'https://www.lensculture.com/'
        localStorage[90] = 'https://www.zhihu.com/'
        localStorage[66] = 'https://www.bilibili.com/'
        localStorage[78] = 'http://lackk.com/go/?url=http://lackk.com/nav/web'
        localStorage[77] = 'https://meiriyiwen.com/'
        localStorage[49] = 'https://1x.com/'
        localStorage[50] = 'https://www.v2ex.com/'
        localStorage[51] = 'https://35photo.pro/'
        localStorage[53] = 'http://588ku.com/'
    }

    for (var i in $keys) {
        if (!$keys.hasOwnProperty(i)) continue

        keys[$keys[i].dataset.key] = {
            'li': $keys[i],
            'span': $keys[i].firstElementChild
        }
    }

    // set favicon
    for (var i = 48; i < 91; i++) {
        var url = localStorage[i]
        if (url) addFavicon(keys[i]['li'], getFavicon(url))
    }

    // read settings
    if (~~localStorage.newWindow) {
        $newWindow.classList.add('active')
    } else {
        $newWindow.classList.remove('active')
    }
    $searchEngine.value = localStorage.searchEngine

    function getFavicon(url) {
        return "https://www.google.cn/s2/favicons?domain=" +  url.split('/').slice(0,3).join('/') 
    }

    function addFavicon($li, src) {
        var img = document.createElement('img')
        img.src = src
        img.className = 'fav'
        $li.appendChild(img)
    }

    function keyDown(key) {
        if (!key) return
        keys[key]['span'].classList.add('keyDownSpan')
        keys[key]['li'].classList.add('keyDownLi')
    }

    function keyUp(key) {
        if (!key) return
        keys[key]['span'].classList.remove('keyDownSpan')
        keys[key]['li'].classList.remove('keyDownLi')
    }

    function openUrl(url) {
        if (~~localStorage.newWindow) {
            window.open(url)
        } else {
            location.href = url
        }
    }

    $search.onkeyup = function(e) {
        if (e.target.value == '@') return $setting.style.bottom = 0
        var key = e.which || e.keyCode || 0;
        if (key == 13) openUrl(localStorage.searchEngine + e.target.value)
    }

    $close.onclick = function() {
        $setting.style.bottom = '-320px'
    }

    var keyCache = 0
    document.onkeydown = function(e) {
        var key = e.which || e.keyCode || 0
        keyCache = key
        if (key == 9) {
            window.event ? window.event.returnValue = false : e.preventDefault()
            if (document.activeElement == $search) {
                $search.blur()
            } else {
                $search.focus()
            }
        }
        keyDown(key)
    }

    document.onkeyup = function(e) {
        var key = e.which || e.keyCode || 0,
            url = localStorage[key]
        keyUp(key)

        if (url && key == keyCache && document.activeElement != $search) openUrl(url)
        keyCache = 0
    }

    $keyboard.onclick = function(e) {
        if (e.target.tagName != 'SPAN') return
        var name = e.target.innerText,
            key = e.target.parentElement.dataset.key || 0,
            url = prompt("请输入按键 " + name + " 对应的网址", localStorage[key] || '')
        if (url === null) return
        if (url && url.indexOf('http') != 0) url = 'http://' + url
        localStorage[key] = url
        location.reload()        
    }

    $newWindow.onclick = function() {
        this.classList.toggle('active')
        localStorage.newWindow = +!!!~~localStorage.newWindow
    }

    $searchEngine.onchange = function(e) {
        localStorage.searchEngine = e.target.value
    }
})()

